<!--===========================================================================
    COMMON_BUILD.XML
    
    This is the build file that is used across all Pentaho projects that are
    using the "new and improved" ivy builds.
    
    This file contains the default implementation of the ant tasks to 
    perform a build. This file should be included by the build.xml file 
    for each project in the Pentaho system. That build file should 
    redefine any task that is defined in this file IF AND ONLY IF the 
    functioning of that task should be different for that specific
    project.
    
    NOTE: Any modification to this file should be viewed as a modification
          the EVERY common_build.xml file (and the change should be copied
          to all common_build.xml files that can be found)
============================================================================-->
<project name="Pentaho Common Build" basedir="." default="jar" xmlns:ivy="antlib:org.apache.ivy.ant">

	<!-- Load the properties files in the proper order -->
	<property file="override.properties" />
	<property file="build.properties" />

	<!-- Build Cache dirs -->
	<property name="build.cache.dir" value="${user.home}/.pentaho_build_cache" />
	<property name="ivy.build.cache.dir" value="${build.cache.dir}/ivy" />
	<property name="cobertura.build.cache.dir" value="${build.cache.dir}/cobertura" />
	<property name="antcontrib.build.cache.dir" value="${build.cache.dir}/ant-contrib" />

	<!-- Ivy properties -->
	<property name="ivy.install.version" value="2.0.0-beta2" />
	<property name="ivy.default.ivy.user.dir" value="${user.home}/.ivy2" />
	<property name="ivy.jar.file" value="${ivy.build.cache.dir}/ivybeta1.jar" />

	<!-- Setup the compile classpath -->
	<path id="classpath">
		<fileset dir="${lib.dir}">
			<include name="*.jar" />
		</fileset>
	</path>

	<!-- Setup the classpath used for testing -->
	<path id="test.classpath">
		<fileset dir="${lib.dir}">
			<include name="*.jar" />
		</fileset>
		<fileset dir="${testlib.dir}">
			<include name="*.jar" />
		</fileset>
		<dirset dir="${bin.dir}" />
		<dirset dir="${testbin.dir}" />
	</path>

	
	<!--=======================================================================
	    install-antcontrib
	    
	    Use IVY to fetch ant-contrib jar and install ant tasks.
	    ====================================================================-->	
	<target name="install-antcontrib" depends="install-ivy">
		<ivy:retrieve inline="true" organisation="ant-contrib" module="ant-contrib" revision="1.0b2" 
			pattern="${antcontrib.build.cache.dir}/[module]-[revision].[ext]" />
		<taskdef resource="net/sf/antcontrib/antlib.xml">
			<classpath>
				<fileset dir="${antcontrib.build.cache.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</taskdef>
	</target>
	

	<!--=======================================================================
	    init
	    
	    Ensures that all the required directories exist before processing
	    a build.
	    ====================================================================-->
	<target name="init" description="Initializes the build process">
		<mkdir dir="${bin.dir}" />
		<mkdir dir="${testbin.dir}" />
		<mkdir dir="${dist.dir}" />

		<available property="ivy.ispresent" file="${ivy.jar.file}" />
	</target>

	
	<!--=======================================================================
	    download-ivy
	    
	    Automatically downloads the ivy jar file for use by ant.  If the user
	    is offline and does not have the IVY jar, an error message will print
	    and the build will fail.
	    ====================================================================-->
	<target name="download-ivy" description="Downloads IVY jar file" depends="offline.check">
		<mkdir dir="${ivy.build.cache.dir}" />
		<get src="http://repo1.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar" dest="${ivy.jar.file}" usetimestamp="true" />
	</target>
	<target name="offline.check" if="offline" >
		<antcall target="print-offline-error"/>
	</target>
	<target name="print-offline-error" unless="ivy.ispresent" >
		<echo message="You are offline and do not have IVY installed.  Please install the IVY jar to ${ivy.jar.file}"/>
		<fail/>
	</target>


	<!--=======================================================================
	    install-ivy
	    
	    Installs the ivy jar for use by this ant script
	    ====================================================================-->
	<target name="install-ivy" depends="download-ivy" unless="ivy.isinstalled" description="Installs IVY tasks for use by this build process">
		<path id="ivy.lib.path">
			<fileset dir="${ivy.build.cache.dir}" includes="*.jar" />
		</path>
		<taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path" />
		<ivy:settings url="${ivy.settingsurl}" />
		<property name="ivy.isinstalled" value="true"/>
	</target>


	<!--=======================================================================
	    resolve
	    
	    Using ivy and the dependencies for the project (defined in the ivy.xml
	    file), this task will retrieve the needed files and place them into 
	    the defined directories.
	    ====================================================================-->
	<target name="resolve" depends="install-ivy" unless="offline" description="Retrieves all the dependent libraries">
		<ivy:resolve file="ivy.xml" />
		<ivy:retrieve conf="default" pattern="${lib.dir}/[module]-[revision].[ext]" />
		<ivy:retrieve conf="test" pattern="${testlib.dir}/[module]-[revision].[ext]" />
	</target>


	<!--=======================================================================
	    report
	    
	    Allows ivy to report on the dependencies for this project 
	    ====================================================================-->
	<target name="report" depends="install-ivy" unless="offline" description="Uses IVY to report on the dependency information">
		<ivy:resolve file="ivy.xml" />
		<ivy:report conf="default" />
	</target>


	<!--=======================================================================
	    publish-local-nojar
	    
	    Publishes the jar file for this project to the user's local repository
	    for download by other projects currently being executed on the user's
	    system.
	    ====================================================================-->
	<target name="publish-local-nojar" depends="install-ivy" description="Publishes the jar file to the local repository">
		<ivy:resolve file="ivy.xml" />
		<ivy:publish resolver="local" pubrevision="${project.revision}" overwrite="true">
			<artifacts pattern="${dist.dir}/[artifact].[ext]" />
		</ivy:publish>
	</target>


	<!--=======================================================================
	    publish-local
	    
	    Builds and publishes the jar file for this project to the user's 
	    local repository for download by other projects currently being 
	    executed on the user's system.
	    ====================================================================-->
	<target name="publish-local" depends="jar, publish-local-nojar" description="Builds and publishes the jar file to the local repository" />


	<!--=======================================================================
        publish-pentaho
    
        Creates and publishes the jar file for this project to a Maven2 
        repository. 
        ====================================================================-->
	<target name="publish-pentaho" depends="jar, publish-pentaho-nojar" description="Builds and publishes the jar file to a Maven2 repository" />


	<!--=======================================================================
	    publish-pentaho-nojar
	    
	    Publishes the jar file for this project to a Maven2 repository.
	    ====================================================================-->
	<target name="publish-pentaho-nojar" depends="create-pom" description="Publishes the jar file to a Maven2 repository">
		<sequential>
			<fail message="Required jar not present!">
				<condition>
					<isset property="${dist.dir}/${ivy.artifact.id}.jar" />
				</condition>
			</fail>
			<if>
				<os family="windows" />
				<then>
					<exec executable="cmd">
						<arg value="/c" />
						<arg value="mvn.bat" />
						<arg value="deploy:deploy-file" />
						<arg value="-DrepositoryId=${ivy.repository.id}" />
						<arg value="-Durl=${ivy.repository.publish}" />
						<arg value="-DpomFile=${dist.dir}/pom.xml" />
						<arg value="-Dfile=${dist.dir}/${ivy.artifact.id}.jar" />
					</exec>
				</then>
				<else>
					<exec executable="mvn">
						<arg value="deploy:deploy-file" />
						<arg value="-DrepositoryId=${ivy.repository.id}" />
						<arg value="-Durl=${ivy.repository.publish}" />
						<arg value="-DpomFile=${dist.dir}/pom.xml" />
						<arg value="-Dfile=${dist.dir}/${ivy.artifact.id}.jar" />
					</exec>
				</else>
			</if>
		</sequential>
	</target>


	<!--=======================================================================
	    create-pom
	    
	    Creates the POM file for publishing the jar file to a Maven2 repository.
	    ====================================================================-->
	<target name="create-pom" depends="install-ivy" description="Creates a POM file based on the ivy dependencies">
		<ivy:makepom ivyfile="./ivy.xml" pomfile="${dist.dir}/pom.xml" />
	</target>


	<!--=======================================================================
	    clean-local
	    
	    Removes all the libraries that are currently stored in the user's
	    local repository. 
	    ====================================================================-->
	<target name="clean-local" depends="install-ivy" description="Cleans the local ivy repository">
		<delete dir="${ivy.local.default.root}/${ivy.organisation}/${ivy.module}/${project.revision}" />
	</target>


	<!--=======================================================================
	    clean-jars
	    
	    Removes all the libraries that have been downloaded for this project
	    using the ivy dependencies.
	    ====================================================================-->
	<target name="clean-jars" description="Cleans the libraries that have been downloaded">
		<delete dir="${lib.dir}" />
		<delete dir="${testlib.dir}" />
	</target>


	<!--=======================================================================
	    clean
	    
	    Removes all the files generated from the build process.
	    ====================================================================-->
	<target name="clean" description="Cleans the files generated from a build" depends="clean-cobertura, clean-dist">
		<delete dir="${bin.dir}" />
		<delete dir="${testbin.dir}" />
	</target>
	
	
	<!--=======================================================================
	    clean-dist
	    
	    Removes all dist artifacts
	    ====================================================================-->
	<target name="clean-dist" description="Removes all dist artifacts">
		<delete dir="${dist.dir}" />
	</target>


	<!--=======================================================================
	    clean-all
	    
	    Removes all the libraries that have been downloaded for this project
	    and all the files generated from the build process.
	    ====================================================================-->
	<target name="clean-all" depends="clean, clean-jars" description="Cleans all the generated/downloaded files" />


	<!--=======================================================================
	    copy-license-lgpl
	    
	    Copies the LGPL license file into the binary directory.
	    ====================================================================-->
	<target name="copy-license-lgpl" if="lgpl-license-avail" description="Copies the LGPL license file into the bin directory">
		<copy todir="${bin.dir}/META-INF">
			<fileset dir="${license.dir}" includes="lgpl-2.1.txt" />
		</copy>
	</target>


	<!--=======================================================================
	    copy-license-gpl-parent
	    
	    Copies the GPL license file from the parent directory into the 
	    binary directory.
	    ====================================================================-->
	<target name="copy-license-gpl-parent" if="gpl-parent-license-avail" description="Copies the parent's GPL license file into the bin directory">
		<copy todir="${bin.dir}/META-INF">
			<fileset dir="../.." includes="gpl-2.0.txt" />
		</copy>
	</target>


	<!--=======================================================================
	    compile
	    
	    Compiles the source code (using the specified options) into the 
	    binary directory.
	    
	    NOTE: This contains multiple sub-tasks which will occur in the 
	          following order (this is provided for easier overriding by
	          the build.xml which will include this file)...
	      - compile.pre      : anything needed to prep for compile
	      - compile.compile  : the actual compilation step
	      - compile.src_copy : copying the source into the bin directory
	      - compile.res_copy : copying the resources into the bin directory
	      - compile.lic_copy : copying the license information into the bin directory
	      - compile.post     : anything needed after the compile is done 
	    ====================================================================-->
	<target name="compile" depends="init, resolve, compile.pre, compile.compile, compile.src_copy, compile.res_copy, compile.lic_copy, compile.post" description="Performs all the steps to prepare the bin directory with a complete compilation" />


	<!--=======================================================================
	    compile.pre
	    
	    Prepares to perform the compile.
	    ====================================================================-->
	<target name="compile.pre" description="Prepares the compile" />


	<!--=======================================================================
	    compile.compile
	    
	    Performs the actual compile
	    ====================================================================-->
	<target name="compile.compile" depends="init" description="Performs the actual javac compile">
		<javac destdir="${bin.dir}" debug="${javac.debug}" optimize="${javac.optimize}" deprecation="${javac.deprecation}" fork="true" source="${build.source}" target="${build.target}">
			<classpath>
				<path refid="classpath" />
			</classpath>
			<src path="${src.dir}" />
		</javac>
	</target>


	<!--=======================================================================
	    compile.src_copy
	    
	    Copies the source files to the bin directory
	    NOTE: if the dont.copy.source variable exists, this step will be
	          skipped!
	    ====================================================================-->
	<target name="compile.src_copy" depends="init" unless="dont.copy.source" description="Copies the source to the bin directory">
		<copy todir="${bin.dir}" flatten="false">
			<fileset dir="${src.dir}" />
		</copy>
	</target>


	<!--=======================================================================
	    compile.res_copy
	    
	    Copies any needed resources into the bin directory
	    ====================================================================-->
	<target name="compile.res_copy" description="Copies the required resource files after a compile" />


	<!--=======================================================================
	    compile.lic_copy
	    
	    Copies the license file(s) into the bin directory
	    ====================================================================-->
	<target name="compile.lic_copy" depends="init" description="Copies the required license file to the bin directory">
		<condition property="lgpl-license-avail">
			<available file="${license.dir}/lgpl-2.1.txt" />
		</condition>
		<antcall target="copy-license-lgpl" />
		<condition property="gpl-parent-license-avail">
			<available file="../../gpl-2.0.txt" />
		</condition>
		<antcall target="copy-license-gpl-parent" />
	</target>


	<!--=======================================================================
	    compile.post
	    
	    Performs any needed post-compile tasks
	    ====================================================================-->
	<target name="compile.post" description="Post compilation tasks" />


	<!--=======================================================================
	    jar
	    
	    Creates a jar file from the bin directory
	    ====================================================================-->
	<target name="jar" depends="compile" description="Jars up the bin directory after a compile">
		<jar destfile="${dist.dir}/${ivy.artifact.id}.jar">
			<manifest>
				<attribute name="Implementation-Title" value="${impl.title}" />
				<attribute name="Implementation-Version" value="${project.revision}" />
				<attribute name="Implementation-Vendor" value="${impl.vendor}" />
				<attribute name="Implementation-ProductID" value="${impl.productID}" />
			</manifest>
			<fileset dir="${bin.dir}" />
		</jar>
	</target>


	<!--=======================================================================
	    compile-tests
	    
	    Compiles and runs all the tests for the project
	    ====================================================================-->
	<target name="compile-tests" description="Compiles tests">
		<javac destdir="${testbin.dir}" debug="true" optimize="false" source="${build.source}" target="${build.target}" fork="true">
			<src path="${testsrc.dir}" />
			<classpath refid="test.classpath" />
		</javac>
	</target>


	<!--=======================================================================
	    test
	    
	    Compiles and runs all the tests for the project
	    ====================================================================-->
	<target name="test" depends="compile,compile-tests" description="Compiles and runs unit tests">
		<junit printsummary="yes" haltonfailure="yes">
			<classpath refid="test.classpath" />
			<formatter type="plain" />
			<batchtest fork="yes" todir="testbin">
				<fileset dir="${testsrc.dir}" casesensitive="yes">
					<include name="**/Test*.java" />
					<include name="**/*Test.java" />
				</fileset>
			</batchtest>
		</junit>
	</target>


	<!--=======================================================================
		clean-test-reports

		Remove all xml and html JUnit test reports
		====================================================================-->
	<target name="clean-test-reports">
		<delete dir="${testreports.xml.dir}" />
		<delete dir="${testreports.html.dir}" />
	</target>


	<!--=======================================================================
		init-test-reports

		Prepare directories for JUnit test reports
		====================================================================-->
	<target name="init-test-reports" depends="clean-test-reports">
		<mkdir dir="${testreports.xml.dir}" />
		<mkdir dir="${testreports.html.dir}" />
	</target>

	<!--=======================================================================
	    dist
	    
	    Creates a distribution of this project
	    ====================================================================-->
	<target name="dist" depends="jar" description="Creates a distribution" />

	
	<!--=======================================================================
	    javadoc
	    
	    Generates javadoc source documentation for this project
	    ====================================================================-->
	<target name="javadoc" depends="javadoc.init, compile" description="Generates javadoc source documentation for this project">
		<javadoc destdir="${javadoc.dir}/docs/api" access="public" source="1.5" use="true" notree="false" nonavbar="false" noindex="false" 
			splitindex="true" author="true" version="true" maxmemory="256M" nodeprecatedlist="false" nodeprecated="false" 
			packagenames="${javadoc.packages}" sourcepath="${src.dir}" doctitle="${impl.title} API documentation">
			<link href="http://java.sun.com/j2se/1.5.0/docs/api/" />
			<classpath refid="classpath" />
		</javadoc>
	</target>
	
	
	<!--=======================================================================
	    dist-javadoc
	    
	    Generates zip and targz distributions of the javadoc
	    ====================================================================-->
	<target name="dist-javadoc" depends="javadoc.zip, javadoc.targz" description="Generates zip and targz distributions of the javadoc"/>
	
	
	<!--=======================================================================
	    clean-javadoc
	    
	    Removes generated javadoc files (note, this does not remove javadoc distributions.
	    Use clean-dist to remove artifacts from the dist.dir.
	    ====================================================================-->
	<target name="clean-javadoc" description="Removes non-dist generated javadoc files">
		<mkdir dir="${javadoc.dir}" />
	</target>
	
	
	<!--=======================================================================
	    javadoc.init
	    
	    Creates directories for javadoc process
	    ====================================================================-->
	<target name="javadoc.init" depends="clean-javadoc">
		<mkdir dir="${javadoc.dir}" />
	</target>
	
	
	<!--=======================================================================
	    javadoc.zip
	    
	    Creates a zip of the javadoc for distribution
	    ====================================================================-->
	<target name="javadoc.zip" depends="javadoc">
		<jar jarfile="${dist.dir}/${ivy.artifact.id}-${project.revision}-javadoc.zip" 
			basedir="${javadoc.dir}" includes="**/*" excludes="**/Thumbs.db" />
	</target>
	
	
	<!--=======================================================================
	    javadoc.targz
	    
	    Creates a gzipped tar of the javadoc for distribution
	    ====================================================================-->
	<target name="javadoc.targz" depends="javadoc">
		<tar compression="gzip" destfile="${dist.dir}/${ivy.artifact.id}-${project.revision}-javadoc.tar.gz" 
			basedir="${javadoc.dir}" includes="**/*" excludes="**/Thumbs.db" />
	</target>


	<!--=======================================================================
	    cobertura
	    
	    Runs tests in an instrumented environment and produces Cobertura test coverage reports
	    ====================================================================-->
	<target name="cobertura" depends="clean-cobertura,cobertura.install,compile,compile-tests,cobertura.instrument-classes,cobertura.test-instrumented,cobertura.xml-report,cobertura.html-report" 
		description="Compile, instrument classes, run the tests and generate Cobertura coverage reports." />


	<!--=======================================================================
	    cobertura.instrument-classes
	    
	    Instruments the application classes used by Cobertura during cobertura.test-instrumented
	    ====================================================================-->
	<target name="cobertura.instrument-classes" depends="cobertura.clean-instrumented-classes,cobertura.install,compile">
		<cobertura-instrument todir="${bin.instrumented.dir}" datafile="${coverage.dir}/cobertura.ser">
			<ignore regex="org.apache.log4j.*" />
			<fileset dir="${bin.dir}">
				<!--
					Instrument all the application classes, but
					don't instrument the test classes.
				-->
				<include name="**/*.class" />
				<exclude name="**/*Test.class" />
			</fileset>

		</cobertura-instrument>
	</target>


	<!--=======================================================================
	    cobertura.install
	    
	    Downloads Cobertura jar and installs ant tasks
	    ====================================================================-->
	<target name="cobertura.install" unless="offline" depends="install-ivy">
		<ivy:retrieve inline="true" organisation="net.sourceforge.cobertura" module="cobertura" revision="1.9" pattern="${cobertura.build.cache.dir}/[module].[ext]" />
		<path id="cobertura.classpath">
			<fileset dir="${cobertura.build.cache.dir}">
				<include name="*.jar" />
			</fileset>
		</path>
		<taskdef classpathref="cobertura.classpath" resource="tasks.properties" />
	</target>


	<!--=======================================================================
	    cobertura.clean
	    
	    Removes all files created by Cobertura code coverage utility
	    ====================================================================-->
	<target name="clean-cobertura" depends="cobertura.clean-instrumented-classes,cobertura.clean-coverage-reports" 
		description="Removes all files created by Cobertura code coverage utility.">
		<delete file="${coverage.dir}" />
	</target>


	<!--=======================================================================
		cobertura.clean-instrumented-classes

		Remove the instrumented classes used by Cobertura
		====================================================================-->
	<target name="cobertura.clean-instrumented-classes">
		<delete dir="${bin.instrumented.dir}" />
	</target>


	<!--=======================================================================
		cobertura.clean-coverage-reports

		Remove all xml and html Cobertura coverage reports
		====================================================================-->
	<target name="cobertura.clean-coverage-reports">
		<delete dir="${coveragereports.dir}" />
	</target>


	<!--=======================================================================
		cobertura.clean-coverage-reports

		Sets up directories for Cobertura coverage reports
		====================================================================-->
	<target name="init-coverage-reports" depends="cobertura.clean-coverage-reports">
		<mkdir dir="${coveragereports.xml.dir}" />
		<mkdir dir="${coveragereports.html.dir}" />
	</target>


	<!--=======================================================================
	    cobertura.test-instrumented
	    
	    Runs tests against instrumented classes and generates xml and html JUnit test reports
	    ====================================================================-->
	<target name="cobertura.test-instrumented" depends="init-test-reports,cobertura.install,compile,compile-tests,cobertura.instrument-classes">
		<mkdir dir="${bin.instrumented.dir}" />
		<junit fork="yes" failureProperty="test.failed">

			<!--
				Specify the name of the coverage data file to use.
			-->
			<sysproperty key="net.sourceforge.cobertura.datafile" file="${coverage.dir}/cobertura.ser" />

			<!--
				Note the classpath order: instrumented classes are before the
				original (uninstrumented) classes.  This is important.
			-->
			<classpath location="${bin.instrumented.dir}" />
			<classpath location="${bin.dir}" />
			<classpath location="${testbin.dir}" />
			<classpath refid="test.classpath" />
			<classpath refid="cobertura.classpath" />

			<formatter type="xml" />
			<test name="${testcase}" todir="${testreports.xml.dir}" if="testcase" />
			<batchtest todir="${testreports.xml.dir}" unless="testcase">
				<fileset dir="${testsrc.dir}" casesensitive="yes">
					<include name="**/*Test.java" />
					<include name="**/*Test.java" />
				</fileset>
			</batchtest>
		</junit>

		<junitreport todir="${testreports.html.dir}">
			<fileset dir="${testreports.xml.dir}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="frames" todir="${testreports.html.dir}" />
		</junitreport>
	</target>


	<!--=======================================================================
	    cobertura.xml-report
	    
	    Produces machine-readable xml Cobertura coverage report from results of instrumented tests
	    ====================================================================-->
	<target name="cobertura.xml-report" depends="cobertura.test-instrumented">
		<cobertura-report destdir="${coveragereports.xml.dir}" datafile="${coverage.dir}/cobertura.ser" format="xml">
			<fileset dir="${src.dir}">
				<include name="**/*.java" />
			</fileset>
		</cobertura-report>
	</target>


	<!--=======================================================================
	    cobertura.html-report
	    
	    Produces human-readable html Cobertura coverage report from results of instrumented tests
	    ====================================================================-->
	<target name="cobertura.html-report" depends="cobertura.test-instrumented">
		<cobertura-report destdir="${coveragereports.html.dir}" datafile="${coverage.dir}/cobertura.ser" format="html">
			<fileset dir="${src.dir}">
				<include name="**/*.java" />
			</fileset>
		</cobertura-report>
	</target>

</project>
